{% extends "base.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='gerer_pts_collecte.css') }}">
{% endblock %}

{% block title %}Gestion des Points de Collecte{% endblock %}

{% block content %}
<h1>Gestion des Points de Collecte</h1>
<div class="gere">
    <div class="container-gere">
        <div id="mapid"></div>
        <div class="form">
            <h2>Ajouter un Points de Collecte</h2>

            <!-- Formulaire pour ajouter un nouveau point de collecte -->
            <form method="post" action="{{ url_for('gerer_pts_collecte') }}">
                {{ form.hidden_tag() }}
                <div>
                    {{ form.adresse.label }} {{ form.adresse(size=20) }}
                </div>
                <div>
                    {{ form.nom_pt_collecte.label }} {{ form.nom_pt_collecte(size=20) }}
                </div>
                <div>
                    {{ form.quantite_max.label }} {{ form.quantite_max(size=10) }}
                </div>
                <div>
                    {{ form.submit() }}
                </div>
            </form>
        </div>
    </div>
    
    <div class="pts">
        <h2>Liste des Points de Collecte</h2>
        <ul>
            {% for pt in points_de_collecte %}
            <li>
                <ul>
                    <li><p><strong>Nom : </strong>{{ pt.nom_pt_collecte }}</p></li>
                    <li><p><strong>Adresse : </strong>{{ pt.adresse }}</p></li>
                    <li><p><strong>Quantité max : </strong>{{ pt.quantite_max }}</p></li>
                </ul>

                <!-- Lien pour modifier avec confirmation -->
                <a href="javascript:void(0);"
                    onclick="confirmEdit('{{ url_for('modifier_pt_collecte', id=pt.id_point_de_collecte) }}')">
                    Modifier
                </a>

                <!-- Lien pour supprimer avec confirmation -->
                <a href="javascript:void(0);"
                    onclick="confirmDelete('{{ url_for('supprimer_pt_collecte', id=pt.id_point_de_collecte) }}')"
                    style="color: red; margin-left: 10px;">
                    Supprimer
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>

    <script>
        function confirmEdit(url) {
            if (confirm("Êtes-vous sûr de vouloir modifier ce point de collecte ?")) {
                window.location.href = url;  // Redirige vers l'URL de modification
            }
        }
        function confirmDelete(url) {
            if (confirm("Êtes-vous sûr de vouloir supprimer ce point de collecte ?")) {
                window.location.href = url;  // Redirige vers l'URL de suppression
            }
        }
        document.addEventListener("DOMContentLoaded", function () {
            // Initialisation de la carte et centrage sur la Guadeloupe
            var map = L.map('mapid').setView([16.2650, -61.5510], 10); // Guadeloupe

            // Ajout des tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Fonction pour géocoder une adresse avec Nominatim
            function geocodeAddress(address, callback) {
                fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(address))
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            var latLng = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                            callback(latLng); // Appel du callback avec les coordonnées obtenues
                        } else {
                            console.log("Adresse non trouvée : " + address);
                        }
                    })
                    .catch(error => console.error('Erreur de géocodage :', error)); // Gestion des erreurs
            }

            // Récupérer les adresses depuis le serveur (passées depuis Flask)
            var addresses = [
                {% for point in points_de_collecte %}
        {
                address: "{{ point.adresse }}",
                name: "{{ point.nom_pt_collecte }}",
                detailUrl: "{{ url_for('detaille', id=point.id_point_de_collecte) }}"
            },
            {% endfor %}
    ];

        // Parcours des adresses et ajout des marqueurs après géocodage
        addresses.forEach(function (location) {
            geocodeAddress(location.address, function (latLng) {
                // Vérifier que les coordonnées sont valides avant d'ajouter le marqueur
                if (latLng) {
                    L.marker(latLng).addTo(map)
                        .bindPopup(
                            `<strong>${location.name}</strong><br>
              <button onclick="window.location.href='${location.detailUrl}'">Voir le détail</button>`
                        ); // Ajout d'une popup avec le nom et le bouton
                }
            });
        });

});
    </script>

    {% endblock %}