{% extends "base.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="static/insertion_dechets.css">
{%endblock%}

{% block title %}Insertion des déchets{% endblock %}

{% block content %}
<h1 class="insert-title">Insertion des déchets</h1>
<form class="form-horizontal" role="form" method="POST" action="{{ url_for ('insert_dechets') }}">
    {{ form.hidden_tag() }}
    <div class="form-group">
        <label for="nom" class="col-sm-2 control-label">{{ form.nom.label }}</label>
        <div>
            {{ form.nom(class_="form-control", placeholder="Nom du déchet") }}
        </div>
    </div>
    <div class="form-group">
        <label for="type" class="col-sm-2 control-label">{{ form.type.label }}</label>
        <div>
            {{ form.type(class_="form-control") }}
        </div>
    </div>
    <div class="form-group">
        <label for="quantite" class="col-sm-2 control-label">{{ form.quantite.label }}</label>
        <div>
            {{ form.quantite(class_="form-control", placeholder="Volume des déchets") }}
        </div>
    </div>
    <div class="form-group">
        <label for="id_point_collecte" class="col-sm-2 control-label">{{ form.id_point_collecte.label }}</label>
        <div>
            {{ form.id_point_collecte(class_="form-control", placeholder="Point de collecte") }}
            <!-- {% for point in form.id_point_collecte.choices %}
                <p>{{ point }}</p>
                <p>{{ point.id_point_de_collecte }}</p>
                <p>{{ point[0] }}</p>
            {% endfor %} -->
        </div>
    </div>
    <div id="mapid"></div>
    <div class="form-group">
        {% if error %}
            <p class="erreur"><strong>Erreur : </strong>{{ error }}</p>
        {% endif %}
        <div class="les-btn">
            {{ form.submit(class_="btn-insert") }}
        </div>
    </div>  
</form>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialisation de la carte et centrage sur la Guadeloupe
    var map = L.map('mapid').setView([16.2450, -61.5110], 9); // Guadeloupe

    // Ajout des tuiles OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Fonction pour géocoder une adresse avec Nominatim
    function geocodeAddress(address, callback) {
      fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(address))
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            var latLng = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
            callback(latLng); // Appel du callback avec les coordonnées obtenues
          } else {
            console.log("Adresse non trouvée : " + address);
          }
        })
        .catch(error => console.error('Erreur de géocodage :', error)); // Gestion des erreurs
    }

    // Récupérer les adresses depuis le serveur (passées depuis Flask)
    var addresses = [
      {% for point in points_de_collecte %}
        { 
          address: "{{ point.adresse }}", 
          name: "{{ point.nom_point }}", 
          id: "{{ point.id_point_de_collecte }}" // Ajout de l'ID du point de collecte
        },
      {% endfor %}
    ];

    // Parcours des adresses et ajout des marqueurs après géocodage
    addresses.forEach(function (location) {
      geocodeAddress(location.address, function (latLng) {
        // Vérifier que les coordonnées sont valides avant d'ajouter le marqueur
        if (latLng) {
          L.marker(latLng).addTo(map)
            .bindPopup(
              `<strong>${location.name}</strong><br>
              <button type="button" onclick="selectPointDeCollecte('${location.id}')">Sélectionner ce point</button>`
            ); // Ajout d'un bouton pour sélectionner le point
        }
      });
    });
  });

  // Fonction JavaScript pour mettre à jour le champ id_point_collecte
  function selectPointDeCollecte(id) {
    document.querySelector("select[name='id_point_collecte']").value = id;
  }
</script>
{% endblock %}